<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>login-signup form</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="/css/loginsignup.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="inner-box" id="card">
          <div class="card-front">
            <h2>Log In</h2>
            <form id="login-form">
              <input
                type="username"
                class="input-box"
                placeholder="username"
                name="username"
                required
              />
              <input
                type="password"
                class="input-box"
                placeholder="Password"
                name="password"
                required
              />
              <button type="submit" class="submit-btn">Login</button>
              <input type="checkbox" name="remember" /><span>Remember Me</span>
            </form>
            <button type="button" class="btn" onclick="openRegister()">
              I'm New Here
            </button>
            <a href="">Forgot Password</a>
          </div>

          <div class="card-back">
            <h2>Register</h2>
            <form id="register-form">
              <input
                type="text"
                class="input-box"
                placeholder="Username"
                name="username"
                required
              />
              <input
                type="email"
                class="input-box"
                placeholder="Your Email Id"
                name="email"
                required
              />
              <input
                type="password"
                class="input-box"
                placeholder="Password"
                name="password"
                id="signup_pass"
                required
              />
              <input
                type="password"
                class="input-box"
                placeholder="Re-enter password"
                name="re_password"
                id="re_signup_pass"
                required
              />
              <button type="submit" class="submit-btn" id="submit-btn">
                Submit
              </button>
              <input type="checkbox" /><span>Remember Me</span>
            </form>
            <button type="button" class="btn" onclick="openLogin()">
              I've an account
            </button>
          </div>
        </div>
      </div>
      <a class="go-home" href="/">go to Home page</a>
    </div>

    <!-- HTML code for the modal -->
    <div id="error-modal" class="modal">
      <div class="modal-content">
        <h2></h2>
        <p id="error-message"></p>
        <button id="close-modal-button">OK</button>
      </div>
    </div>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script>
      const register_form = document.getElementById("register-form");
      const container  = document.querySelector('.container');

      // JavaScript code to show the modal with the error/success message
      const errorMessage = document.getElementById("error-message");
      const modal = document.getElementById("error-modal");
      const closeModalButton = document.getElementById("close-modal-button");
      const modalHeading = document.querySelector(".modal-content h2");


      //login form selectors:-
      const login_form= document.getElementById('login-form');

      login_form.addEventListener('submit',(e)=>{
        e.preventDefault();
        sendDataforLogin();
      })

      function openRegister() {
        card.style.transform = "rotateY(-180deg)";
      }
      function openLogin() {
        card.style.transform = "rotateY(0deg)";
      }
      register_form.addEventListener("submit", (e) => {
        e.preventDefault();
        sendDataforRegistration();
      });

      // let isValid = true;

      function sendDataforRegistration() {
        const usernameInput = document.querySelector(
          '#register-form input[name="username"]'
        );
        const emailInput = document.querySelector(
          '#register-form input[name="email"]'
        );
        const passwordInput = document.querySelector(
          '#register-form input[name="password"]'
        );
        const rePasswordInput = document.querySelector(
          '#register-form input[name="re_password"]'
        );
        const rememberMeCheckbox = document.querySelector(
          '#register-form input[type="checkbox"]'
        );

        const formData = {
          username: usernameInput.value,
          email: emailInput.value,
          password: passwordInput.value,
        };

        fetch("/signup/new", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            return response.json();
          })
          .then((response) => {
            if (response.shouldreg) {
              showErrorModal(
                `you have been successfully registered click on "OK" to go to Login page`,
                "SUCCESSFUL"
              );
            }else{
              let toShow = `the user with username ${response.data.username} is already registered..Please try to log-in! `;
              showErrorModal(toShow,"Oops!");
            }
          })
          .catch((err) => {
            showErrorModal(err, "Error occurred from server!");
          });
      }

      // When an error occurs, set the error message and show the modal
      function showErrorModal(message, state) {
        errorMessage.textContent = message;
        modalHeading.textContent = state;

        container.classList.add("blur");
        modal.classList.add("show");
      }

      // When the user clicks the close button, hide the modal
      closeModalButton.addEventListener("click", function () {
        modal.classList.remove("show");
        window.location.href = "/signup";
      });


      function sendDataforLogin(){
        const usernameInput = document.querySelector(
          '#login-form input[name="username"]'
        );
        const passwordInput = document.querySelector(
          '#login-form input[name="password"]'
        );

        const formData = {
          username:usernameInput.value,
          password:passwordInput.value
        }

        fetch("/signup/exist", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            return response.json();
          })
          .then((response) => {
            if(response.shouldlogin){
        window.location.href = "/home";
          }else{
            showErrorModal(`the user is not registered!`,"Sorry!")
          }

          })
          .catch((err) => {
            showErrorModal(err, "Error occurred from server!");
          });
      }
    </script>
  </body>
</html>
